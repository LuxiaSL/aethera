name: Deploy to VPS

on:
  push:
    branches: [main]
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# Required VPS Setup:
# 1. Caddy reverse proxy configured for aetherawi.red
#    (WebSocket support is automatic with Caddy)
# 2. /opt/aethera-server/core/.env file with:
#    - AETHERA_TRIPCODE_SALT=<your-salt>
#    - DREAM_GEN_AUTH_TOKEN=<shared-secret-with-runpod>
#    - RUNPOD_API_KEY=<your-runpod-api-key>
#    - RUNPOD_ENDPOINT_ID=<your-endpoint-id>

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            echo "ðŸ“¦ Pulling latest changes..."
            cd /opt/aethera-server/core
            git pull origin main
            
            echo "ðŸ”¨ Building Docker image..."
            docker build -t aethera:latest .
            
            echo "ðŸ”„ Restarting container..."
            docker stop aethera || true
            docker rm aethera || true
            docker run -d \
              --name aethera \
              --restart unless-stopped \
              -p 127.0.0.1:8000:8000 \
              --env-file /opt/aethera-server/core/.env \
              -v /opt/aethera-server/core/data:/app/data \
              aethera:latest
            
            echo "â³ Waiting for container to be healthy..."
            sleep 5
            for i in {1..12}; do
              if curl -sf http://localhost:8000/healthz > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                break
              fi
              echo "   Waiting... ($i/12)"
              sleep 5
            done
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deploy complete!"
            docker ps | grep aethera
            
            echo ""
            echo "ðŸŒ™ Dreams module ready at /dreams"
            echo "   Make sure .env has DREAM_GEN_AUTH_TOKEN, RUNPOD_API_KEY, RUNPOD_ENDPOINT_ID"


