{% extends "base.html" %}

{% block meta %}
<meta name="description" content="{{ post.excerpt }}">
{% if post.canonical_url %}
<link rel="canonical" href="{{ post.canonical_url }}">
{% endif %}
<meta name="license" content="{{ post.license }}">
<meta name="author" content="{{ post.author }}">
{% if post.tags %}
<meta name="keywords" content="{{ post.tags }}">
{% endif %}

<!-- Open Graph -->
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.excerpt }}">
<meta property="og:url" content="{{ request.url }}">
<meta property="og:type" content="article">
<meta property="og:site_name" content="LuxiBlog">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="{{ post.title }}">
<meta name="twitter:description" content="{{ post.excerpt }}">

<link rel="alternate" type="application/rss+xml" href="/feed.xml" />
{% endblock %}

{% block content %}
<article class="post">
    <header class="mb-8">
        <h1 class="text-3xl font-bold mb-3">{{ post.title }}</h1>
        <div class="text-text-muted">
            <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%B %d, %Y') }}</time>
            {% if post.author %} · {{ post.author }}{% endif %}
        </div>

        {% if post.tags %}
        <div class="mt-4">
            {% for tag in post.get_tags_list() %}
            <span
                class="inline-block bg-accent-soft text-text-muted text-xs px-3 py-1 rounded-sm mr-2 opacity-80 hover:opacity-100 transition-opacity">{{
                tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    <div class="post-content prose lg:prose-lg max-w-none text-text">
        {{ post.content_html | safe }}
    </div>

    <footer class="post-footer">
        <span>{% if post.categories %}{% for category in post.get_categories_list() %}<a href="/category/{{ category }}">{{ category }}</a>{% if not loop.last %}, {% endif %}{% endfor %}{% else %}Uncategorized{% endif %}</span>
        <span class="separator">·</span>
        <span><a href="https://creativecommons.org/licenses/by/4.0/">{{ post.license }}</a></span>
    </footer>
</article>

<section class="circuit-box comments-section mt-12 bg-bg-soft">
    <h2 class="text-2xl font-bold mb-6">Comments</h2>

    <!-- Comment form -->
    <div class="comment-form mb-8">
        <form hx-post="/posts/{{ post.slug }}/comments" hx-target="#comments-container" hx-swap="afterbegin"
            hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('no-comments-placeholder')?.remove(); }"
            class="bg-bg-elevated p-4 rounded border-l-2 border-accent">
            
            <!-- Name and Tripcode fields - horizontal on desktop -->
            <div class="form-row">
                <div class="form-field">
                    <label for="author">Name</label>
                    <input type="text" name="author" id="author" placeholder="Anonymous">
                </div>
                <div class="form-field">
                    <label for="password">Tripcode</label>
                    <input type="text" name="password" id="password" autocomplete="off" placeholder="Optional">
                </div>
            </div>

            <div class="form-field">
                <label for="content">Comment</label>
                <textarea name="content" id="content" rows="3" required
                    placeholder="Write your comment... (Markdown supported, >>123 to reference)"></textarea>
            </div>

            <button type="submit">Post Comment</button>
        </form>
    </div>

    <!-- Comments container with SSE for live updates -->
    <div id="comments-container" hx-sse="connect:/stream/comments/{{ post.id }}">
        <!-- Initially load comments -->
        {% include "fragments/comments.html" %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Script for handling comment references
    document.addEventListener('click', function (e) {
        if (e.target.matches('.comment-reference')) {
            e.preventDefault();
            const targetId = e.target.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
                // Briefly highlight the comment
                targetElement.classList.add('bg-yellow-100');
                setTimeout(() => {
                    targetElement.classList.remove('bg-yellow-100');
                }, 2000);
            }
        }
    });

    // Listen for new comments
    document.body.addEventListener('htmx:sseMessage', function (evt) {
        if (evt.detail.name === 'new_comment') {
            // Flash notification or visual indicator that a new comment arrived
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg';
            notification.textContent = 'New comment received!';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    });

    // Gracefully close SSE connection on page unload to prevent browser errors
    window.addEventListener('beforeunload', function () {
        const commentsContainer = document.getElementById('comments-container');
        if (commentsContainer && commentsContainer['htmx-internal-data'] && commentsContainer['htmx-internal-data'].sseEventSource) {
            commentsContainer['htmx-internal-data'].sseEventSource.close();
        }
    });
</script>
{% endblock %}