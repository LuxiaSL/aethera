{% extends "base.html" %}

{% block title %}IRC Generation Control Panel | æthera{% endblock %}

{% block extra_head %}
<link href="/static/css/irc-admin.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="irc-admin-page">
    <!-- Page Header -->
    <header class="admin-page-header">
        <h1>irc generation control panel</h1>
        <div class="session-info">
            <span id="session-status" class="status-badge idle">no session</span>
            <span id="session-id"></span>
        </div>
    </header>

    <!-- Config Bar - Vertical Layout with Smart Grouping -->
    <div class="config-bar">
        <!-- Row 1: Session + Profiles + Control -->
        <div class="config-row">
            <!-- Session Controls -->
            <div class="config-bar-section fixed-small">
                <div class="config-bar-header">
                    <span class="toggle-icon">▼</span>
                    <h2>session</h2>
                </div>
                <div class="config-bar-content" id="session-content">
                    <div class="button-group">
                        <button id="btn-new-session" class="btn btn-primary">new session</button>
                        <button id="btn-delete-session" class="btn btn-danger" disabled>delete</button>
                    </div>
                </div>
            </div>

            <!-- Settings Profiles -->
            <div class="config-bar-section fixed-medium">
                <div class="config-bar-header">
                    <span class="toggle-icon">▶</span>
                    <h2>profiles</h2>
                </div>
                <div class="config-bar-content" id="profiles-content">
                    <div class="profiles-list" id="profiles-list"></div>
                    <div class="profile-actions">
                        <div class="profile-save-row">
                            <input type="text" id="profile-name" placeholder="profile name" maxlength="32">
                            <button id="btn-save-profile" class="btn btn-small btn-primary">save</button>
                        </div>
                        <div class="profile-io-row">
                            <button id="btn-export-profile" class="btn btn-small">export json</button>
                            <label class="btn btn-small btn-import">
                                import
                                <input type="file" id="btn-import-profile" accept=".json" hidden>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Mode -->
            <div class="config-bar-section">
                <div class="config-bar-header">
                    <span class="toggle-icon">▼</span>
                    <h2>control</h2>
                </div>
                <div class="config-bar-content" id="control-content">
                    <div class="control-mode-row">
                        <label class="control-radio">
                            <input type="radio" name="control-mode" value="autonomous" checked>
                            <span>autonomous</span>
                        </label>
                        <label class="control-radio">
                            <input type="radio" name="control-mode" value="confirm_step">
                            <span>confirm step</span>
                        </label>
                        <label class="control-radio">
                            <input type="radio" name="control-mode" value="manual_select">
                            <span>manual select</span>
                        </label>
                        <label class="control-checkbox">
                            <input type="checkbox" id="dry-run">
                            <span>dry run</span>
                        </label>
                    </div>
                    <div class="action-buttons">
                        <button id="btn-start" class="btn btn-success" disabled>start generation</button>
                        <button id="btn-stop" class="btn btn-warning" disabled>stop</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Generator + Judge (side by side) -->
        <div class="config-row">
            <!-- Generation Provider -->
            <div class="config-bar-section">
                <div class="config-bar-header">
                    <span class="toggle-icon">▶</span>
                    <h2>generator</h2>
                </div>
                <div class="config-bar-content" id="gen-provider-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gen-provider">provider</label>
                            <select id="gen-provider">
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openai">OpenAI</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="local">Local / Custom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gen-model">model</label>
                            <input type="text" id="gen-model" placeholder="e.g., claude-3-5-sonnet-20241022">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group api-key-group" id="gen-api-key-group">
                            <label for="gen-api-key">
                                api key 
                                <span id="gen-api-key-status" class="api-key-status"></span>
                            </label>
                            <input type="password" id="gen-api-key" placeholder="Leave blank to use env var">
                        </div>
                        <div class="form-group" id="gen-base-url-group" style="display: none;">
                            <label for="gen-base-url">base url</label>
                            <input type="text" id="gen-base-url" placeholder="http://localhost:8000/v1">
                        </div>
                    </div>
                    <div class="form-row sliders">
                        <div class="form-group">
                            <label for="gen-temp">temp: <span id="gen-temp-val">0.9</span></label>
                            <input type="range" id="gen-temp" min="0" max="2" step="0.1" value="0.9">
                        </div>
                        <div class="form-group">
                            <label for="gen-top-p">top-p: <span id="gen-top-p-val">1.0</span></label>
                            <input type="range" id="gen-top-p" min="0" max="1" step="0.05" value="1.0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Judge Provider -->
            <div class="config-bar-section">
                <div class="config-bar-header">
                    <span class="toggle-icon">▶</span>
                    <h2>judge</h2>
                </div>
                <div class="config-bar-content" id="judge-provider-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="judge-provider">provider</label>
                            <select id="judge-provider">
                                <option value="openai" selected>OpenAI</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="local">Local / Custom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="judge-model">model</label>
                            <input type="text" id="judge-model" placeholder="e.g., gpt-4o, o3, o3-mini">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group api-key-group" id="judge-api-key-group">
                            <label for="judge-api-key">
                                api key 
                                <span id="judge-api-key-status" class="api-key-status"></span>
                            </label>
                            <input type="password" id="judge-api-key" placeholder="Leave blank to use env var">
                        </div>
                        <div class="form-group" id="judge-base-url-group" style="display: none;">
                            <label for="judge-base-url">base url</label>
                            <input type="text" id="judge-base-url" placeholder="http://localhost:8000/v1">
                        </div>
                    </div>
                    <div class="form-row sliders">
                        <div class="form-group">
                            <label for="judge-temp">temp: <span id="judge-temp-val">0.3</span></label>
                            <input type="range" id="judge-temp" min="0" max="2" step="0.1" value="0.3">
                        </div>
                        <div class="form-group">
                            <label for="judge-top-p">top-p: <span id="judge-top-p-val">1.0</span></label>
                            <input type="range" id="judge-top-p" min="0" max="1" step="0.05" value="1.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Fragment + Loop -->
        <div class="config-row">
            <!-- Fragment Parameters -->
            <div class="config-bar-section">
                <div class="config-bar-header">
                    <span class="toggle-icon">▶</span>
                    <h2>fragment</h2>
                </div>
                <div class="config-bar-content" id="fragment-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="frag-style">style</label>
                            <select id="frag-style">
                                <option value="">Random</option>
                                <option value="technical">Technical</option>
                                <option value="philosophical">Philosophical</option>
                                <option value="chaotic">Chaotic</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="frag-collapse">collapse type</label>
                            <select id="frag-collapse">
                                <option value="">Random</option>
                                <option value="netsplit">Netsplit</option>
                                <option value="gline">G-Line</option>
                                <option value="mass_kick">Mass Kick</option>
                                <option value="ping_timeout">Ping Timeout</option>
                                <option value="sendq_exceeded">SendQ Exceeded</option>
                                <option value="corruption">Corruption</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="frag-target">target: <span id="frag-target-val">25</span></label>
                            <input type="range" id="frag-target" min="10" max="60" step="5" value="25">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loop Settings -->
            <div class="config-bar-section">
                <div class="config-bar-header">
                    <span class="toggle-icon">▶</span>
                    <h2>loop</h2>
                </div>
                <div class="config-bar-content" id="loop-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loop-batch">batch: <span id="loop-batch-val">10</span></label>
                            <input type="range" id="loop-batch" min="1" max="20" step="1" value="10">
                        </div>
                        <div class="form-group">
                            <label for="loop-threshold">threshold: <span id="loop-threshold-val">0.4</span></label>
                            <input type="range" id="loop-threshold" min="0" max="1" step="0.05" value="0.4">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Prompts (Full Width) -->
        <div class="config-row">
            <div class="config-bar-section prompts-section full-width">
                <div class="config-bar-header">
                    <span class="toggle-icon">▶</span>
                    <h2>prompts</h2>
                </div>
                <div class="config-bar-content" id="prompts-content">
                    <div class="prompt-group">
                        <div class="prompt-header">
                            <label for="prompt-gen-system">gen system</label>
                            <button type="button" class="btn btn-tiny btn-reset" data-reset="prompt-gen-system">reset</button>
                            <button type="button" class="btn btn-tiny btn-view-default" data-view="generation.system_prompt">view</button>
                        </div>
                        <textarea id="prompt-gen-system" class="prompt-textarea" rows="3" placeholder="Leave blank for default"></textarea>
                    </div>
                    <div class="prompt-group">
                        <div class="prompt-header">
                            <label for="prompt-judge-system">judge system</label>
                            <button type="button" class="btn btn-tiny btn-reset" data-reset="prompt-judge-system">reset</button>
                            <button type="button" class="btn btn-tiny btn-view-default" data-view="judge.system_prompt">view</button>
                        </div>
                        <textarea id="prompt-judge-system" class="prompt-textarea" rows="3" placeholder="Leave blank for default"></textarea>
                    </div>
                    <div class="prompt-group">
                        <div class="prompt-header">
                            <label for="prompt-judge-user">judge user</label>
                            <button type="button" class="btn btn-tiny btn-reset" data-reset="prompt-judge-user">reset</button>
                            <button type="button" class="btn btn-tiny btn-view-default" data-view="judge.user_template">view</button>
                        </div>
                        <textarea id="prompt-judge-user" class="prompt-textarea" rows="3" placeholder="Leave blank for default"></textarea>
                    </div>
                    <div class="prompt-group">
                        <div class="prompt-header">
                            <label for="prompt-judge-user-first">judge first</label>
                            <button type="button" class="btn btn-tiny btn-reset" data-reset="prompt-judge-user-first">reset</button>
                            <button type="button" class="btn btn-tiny btn-view-default" data-view="judge.user_template_first">view</button>
                        </div>
                        <textarea id="prompt-judge-user-first" class="prompt-textarea" rows="3" placeholder="Leave blank for default"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area (Two Panels) -->
    <div class="admin-layout">
        <!-- Left Panel: Live View -->
        <main class="live-panel">
            <!-- Progress -->
            <section class="progress-section">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-messages">0/25 messages</span>
                    <span id="progress-chunks">chunk 0</span>
                    <span id="progress-phase">idle</span>
                </div>
            </section>

            <!-- Log Stream -->
            <section class="log-section">
                <div class="section-header">
                    <h3>log stream</h3>
                    <button class="btn btn-tiny btn-expand" data-expand="log-stream">expand</button>
                </div>
                <div id="log-stream" class="log-stream"></div>
            </section>

            <!-- Candidates (Focus Panel) -->
            <section class="candidates-section">
                <div class="section-header">
                    <h3>candidates <span id="candidates-count"></span></h3>
                    <button class="btn btn-tiny btn-expand" data-expand="candidates-grid">expand</button>
                </div>
                <div id="candidates-grid" class="candidates-grid"></div>
                <div id="waiting-indicator" class="waiting-indicator hidden">
                    <span class="waiting-text">waiting for selection...</span>
                    <button id="btn-continue" class="btn btn-primary hidden">continue</button>
                </div>
            </section>

            <!-- Transcript -->
            <section class="transcript-section">
                <div class="section-header">
                    <h3>accumulated transcript</h3>
                    <button class="btn btn-tiny btn-expand" data-expand="transcript">expand</button>
                </div>
                <pre id="transcript" class="transcript"></pre>
            </section>

            <!-- Stats & Export -->
            <section class="stats-export-section">
                <div class="stats-row">
                    <div class="stat">
                        <span class="stat-label">tokens</span>
                        <span id="stat-tokens" class="stat-value">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">cost</span>
                        <span id="stat-cost" class="stat-value">$0.0000</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">time</span>
                        <span id="stat-time" class="stat-value">0s</span>
                    </div>
                </div>
                <div class="export-buttons">
                    <button id="btn-export" class="btn btn-small" disabled>export txt</button>
                    <button id="btn-copy" class="btn btn-small" disabled>copy</button>
                </div>
            </section>
        </main>

        <!-- Right Panel: Model I/O -->
        <aside class="io-panel">
            <!-- Generator I/O -->
            <section class="io-section generator-io">
                <div class="section-header">
                    <h3>generator</h3>
                    <span class="io-model-label" id="gen-model-label">-</span>
                </div>
                <div class="io-content">
                    <div class="io-block">
                        <div class="io-block-header">
                            <span class="io-label">last prompt</span>
                            <button class="btn btn-tiny btn-expand" data-expand="gen-last-prompt">expand</button>
                        </div>
                        <pre id="gen-last-prompt" class="io-text prompt-text">No prompt sent yet</pre>
                    </div>
                    <div class="io-block">
                        <div class="io-block-header">
                            <span class="io-label">selected response</span>
                            <button class="btn btn-tiny btn-expand" data-expand="gen-last-response">expand</button>
                        </div>
                        <pre id="gen-last-response" class="io-text response-text">No response yet</pre>
                    </div>
                </div>
            </section>

            <!-- Judge I/O -->
            <section class="io-section judge-io">
                <div class="section-header">
                    <h3>judge</h3>
                    <span class="io-model-label" id="judge-model-label">-</span>
                </div>
                <div class="io-content">
                    <div class="io-block">
                        <div class="io-block-header">
                            <span class="io-label">last prompt</span>
                            <button class="btn btn-tiny btn-expand" data-expand="judge-last-prompt">expand</button>
                        </div>
                        <pre id="judge-last-prompt" class="io-text prompt-text">No prompt sent yet</pre>
                    </div>
                    <div class="io-block">
                        <div class="io-block-header">
                            <span class="io-label">last response</span>
                            <button class="btn btn-tiny btn-expand" data-expand="judge-last-response">expand</button>
                        </div>
                        <pre id="judge-last-response" class="io-text response-text">No response yet</pre>
                    </div>
                </div>
            </section>
        </aside>
    </div>
</div>

<!-- Expand Modal -->
<div id="expand-modal" class="expand-modal hidden">
    <div class="expand-modal-content">
        <div class="expand-modal-header">
            <h3 id="expand-modal-title">Expanded View</h3>
            <button class="expand-modal-close">&times;</button>
        </div>
        <div class="expand-modal-body">
            <pre id="expand-modal-text"></pre>
        </div>
    </div>
</div>

<!-- Candidate Expanded Modal -->
<div id="candidate-modal" class="expand-modal hidden">
    <div class="expand-modal-content candidate-modal-content">
        <div class="expand-modal-header">
            <h3 id="candidate-modal-title">Candidate</h3>
            <button class="expand-modal-close">&times;</button>
        </div>
        <div class="expand-modal-body candidate-modal-body">
            <pre id="candidate-modal-text"></pre>
        </div>
        <div class="candidate-modal-footer">
            <div class="candidate-modal-nav">
                <button class="btn btn-small" id="candidate-modal-prev">← prev</button>
                <span id="candidate-modal-position">1 / 10</span>
                <button class="btn btn-small" id="candidate-modal-next">next →</button>
            </div>
            <button class="btn btn-primary" id="candidate-modal-select">select this candidate</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/irc-admin.js"></script>
{% endblock %}
