{% extends "base.html" %}

{% block meta %}
<meta name="description" content="{{ post.excerpt }}">
{% if post.canonical_url %}
<link rel="canonical" href="{{ post.canonical_url }}">
{% endif %}
<meta name="license" content="{{ post.license }}">
<meta name="author" content="{{ post.author }}">
{% if post.tags %}
<meta name="keywords" content="{{ post.tags }}">
{% endif %}

<!-- Open Graph -->
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.excerpt }}">
<meta property="og:url" content="{{ request.url }}">
<meta property="og:type" content="article">
<meta property="og:site_name" content="æthera">
<meta property="og:image" content="{{ request.base_url }}static/uploads/og-card.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="article:author" content="{{ post.author }}">
<meta property="article:published_time" content="{{ post.created_at.isoformat() }}">
<meta property="article:modified_time" content="{{ post.updated_at.isoformat() }}">
{% if post.tags %}
{% for tag in post.get_tags_list() %}
<meta property="article:tag" content="{{ tag }}">
{% endfor %}
{% endif %}

<!-- Twitter/X Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@slLuxia">
<meta name="twitter:creator" content="@slLuxia">
<meta name="twitter:title" content="{{ post.title }}">
<meta name="twitter:description" content="{{ post.excerpt }}">
<meta name="twitter:image" content="{{ request.base_url }}static/uploads/og-card.png">
<meta name="twitter:image:alt" content="æthera logo">

<!-- oEmbed Discovery -->
<link rel="alternate" type="application/json+oembed" href="{{ request.base_url }}oembed?url={{ request.url }}&format=json" title="{{ post.title }} oEmbed">

<!-- Theme Color -->
<meta name="theme-color" content="#000000">

<link rel="alternate" type="application/rss+xml" href="/feed.xml" />
{% endblock %}

{% block content %}
<!-- Post title/meta with ellipse background like homepage -->
<header class="post-header-standalone h-entry">
    <h1 class="p-name">{{ post.title }}</h1>
    <div class="post-meta">
        by <span class="p-author h-card">{{ post.author }}</span> · <time class="dt-published" datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%Y-%m-%d') }}</time>{% if post.tags %}<span class="hidden">{% for tag in post.get_tags_list() %}<span class="tag p-category">{{ tag }}</span>{% if not loop.last %}, {% endif %}{% endfor %}</span>{% endif %}
    </div>
    <!-- Hidden machine-readable metadata -->
    <data class="u-url hidden" value="{{ request.url }}"></data>
    {% if post.excerpt %}
    <data class="p-summary hidden" value="{{ post.excerpt }}"></data>
    {% endif %}
</header>

<!-- Post body with rectangular white background -->
<article class="post-body">
    <canvas id="post-caustics-canvas"></canvas>
    <div class="post-content e-content">
        {{ post.content_html | safe }}
    </div>
</article>

<section class="comments-section">

    <!-- Comment form -->
    <div class="comment-form mb-8">
        <form hx-post="/posts/{{ post.slug }}/comments" hx-target="#comments-container" hx-swap="afterbegin"
            hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('no-comments-placeholder')?.remove(); }">
            
            <!-- Name and Tripcode fields - horizontal on desktop -->
            <div class="form-row">
                <div class="form-field">
                    <label for="author">Name</label>
                    <input type="text" name="author" id="author" placeholder="Anonymous">
                </div>
                <div class="form-field">
                    <label for="password">Tripcode</label>
                    <input type="text" name="password" id="password" autocomplete="off" placeholder="optional">
                </div>
            </div>

            <div class="form-field">
                <label for="content">Comment</label>
                <textarea name="content" id="content" rows="3" required
                    placeholder="write your comment... (markdown supported, >>123 to reference)"></textarea>
            </div>

            <button type="submit">Post Comment</button>
        </form>
    </div>

    <!-- Comments container with SSE for live updates -->
    <div id="comments-container" hx-sse="connect:/stream/comments/{{ post.id }}">
        <!-- Initially load comments -->
        {% include "fragments/comments.html" %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- Post caustics background -->
<script src="/static/js/post-caustics.js"></script>
<!-- 4chan-style comment system -->
<script src="/static/js/comments.js"></script>
<script>
    // Handle comment reference clicks - smooth scroll for same-page, navigate for cross-post
    document.addEventListener('click', function (e) {
        const ref = e.target.closest('.comment-reference');
        if (!ref) return;
        
        const href = ref.getAttribute('href');
        
        // If it's a same-page anchor, smooth scroll
        if (href.startsWith('#')) {
            e.preventDefault();
            const targetElement = document.querySelector(href);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            }
        }
        // Otherwise let the browser navigate to the cross-post URL
    });

    // Listen for new comments via SSE
    document.body.addEventListener('htmx:sseMessage', function (evt) {
        if (evt.detail.name === 'new_comment') {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
            notification.textContent = 'New comment received!';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    });

    // Gracefully close SSE connection on page unload
    window.addEventListener('beforeunload', function () {
        const container = document.getElementById('comments-container');
        if (container?.['htmx-internal-data']?.sseEventSource) {
            container['htmx-internal-data'].sseEventSource.close();
        }
    });
</script>
{% endblock %}