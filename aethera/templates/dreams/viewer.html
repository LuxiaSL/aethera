{% extends "base.html" %}

{% block title %}Dreams | æthera{% endblock %}

{% block description %}Live AI-generated morphing art. Watch ethereal digital dreams evolve in real-time.{% endblock %}

{% block meta %}
{{ super() }}
<!-- Dreams-specific Open Graph -->
<meta property="og:title" content="Dreams | æthera">
<meta property="og:description" content="Live AI-generated morphing art. Watch ethereal digital dreams evolve in real-time.">
<meta property="og:image" content="{{ request.base_url }}api/dreams/current">
<meta property="og:type" content="website">
<link rel="canonical" href="{{ request.base_url }}dreams">

<!-- Twitter/X Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Dreams | æthera">
<meta name="twitter:description" content="Live AI-generated morphing art">
<meta name="twitter:image" content="{{ request.base_url }}api/dreams/current">
{% endblock %}

{% block schema %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Dreams",
    "description": "Live AI-generated morphing art viewer. Continuously evolving ethereal digital imagery powered by stable diffusion.",
    "url": "{{ request.base_url }}dreams",
    "applicationCategory": "MultimediaApplication",
    "operatingSystem": "Web Browser",
    "author": {
        "@type": "Person",
        "name": "Luxia",
        "url": "{{ request.base_url }}"
    }
}
</script>
{% endblock %}

{% block extra_head %}
<link href="/static/css/dreams.css" rel="stylesheet">
{% endblock %}

{% block content %}
<video id="dreams-video-src" autoplay muted loop playsinline style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px">
    <source src="/static/uploads/dreams_bg.mp4" type="video/mp4">
</video>
<canvas id="dreams-video-canvas" class="dreams-video-bg"></canvas>
<div class="dreams-page">
    <!-- Page header -->
    <header class="dreams-header">
        <h1 class="dreams-title">dreams</h1>
    </header>

    <!-- Main viewer container -->
    <div class="dream-container">
        <!-- Canvas for frame display -->
        <canvas id="dream-canvas" width="1024" height="512"></canvas>
        
        <!-- Loading overlay -->
        <div id="dream-loading" class="dream-loading">
            <div class="dream-loading-content">
                <div class="dream-pulse-container">
                    <div class="dream-pulse"></div>
                    <div class="dream-pulse dream-pulse-delayed"></div>
                </div>
                <span id="dream-status" class="dream-status">connecting...</span>
                <div class="dream-progress">
                    <div id="dream-progress-bar" class="dream-progress-bar"></div>
                </div>
            </div>
        </div>
        
        <!-- Error overlay -->
        <div id="dream-error" class="dream-error hidden">
            <div class="dream-error-content">
                <span class="dream-error-icon">⚠</span>
                <span id="dream-error-message" class="dream-error-message">connection lost</span>
                <button id="dream-retry-btn" class="dream-retry-btn">retry</button>
            </div>
        </div>
    </div>
    
    <!-- Status bar -->
    <div class="dream-status-bar">
        <span id="dream-frame-count" class="dream-stat">
            <span class="dream-stat-label">frame</span>
            <span class="dream-stat-value">—</span>
        </span>
        <span id="dream-viewer-count" class="dream-stat">
            <span class="dream-stat-label">viewers</span>
            <span class="dream-stat-value">—</span>
        </span>
        <span id="dream-connection-status" class="dream-stat">
            <span class="dream-stat-indicator"></span>
            <span class="dream-stat-value">offline</span>
        </span>
    </div>
    
    <!-- Embed & Docs section -->
    <details class="dreams-embed-section">
        <summary>embed this</summary>
        <div class="dreams-embed-content">
            <p>Add Dream Window to your own site:</p>
            <pre class="dreams-embed-code"><code>&lt;iframe 
  src="{{ request.base_url }}dreams?embed=1" 
  width="1024" 
  height="512" 
  frameborder="0"
  loading="lazy"&gt;&lt;/iframe&gt;</code></pre>
            <p class="dreams-embed-note">
                Or fetch the current frame directly: 
                <a href="/api/dreams/current"><code>/api/dreams/current</code></a>
            </p>
        </div>
    </details>
    
    <details class="dreams-embed-section">
        <summary>api documentation</summary>
        <div class="dreams-embed-content">
            <p>Build your own Dream Window client with our API:</p>
            <ul class="dreams-api-links">
                <li><strong>WebSocket:</strong> <code>/ws/dreams</code> — Real-time binary frame stream</li>
                <li><strong>SSE:</strong> <code>/api/dreams/sse</code> — Server-Sent Events alternative</li>
                <li><strong>REST:</strong> <code>/api/dreams/current</code> — Current frame (WebP)</li>
                <li><strong>Status:</strong> <code>/api/dreams/status</code> — System status (JSON)</li>
            </ul>
            <p class="dreams-embed-note">
                <a href="/dreams/api" class="dreams-docs-link">View full API documentation →</a>
            </p>
        </div>
    </details>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/dreams.js"></script>
<script>
// Frame-blended background video for smooth slow-motion
(function() {
    const video = document.getElementById('dreams-video-src');
    const canvas = document.getElementById('dreams-video-canvas');
    if (!video || !canvas) return;

    const ctx = canvas.getContext('2d');
    const blendRate = 0.02; // How fast to blend toward current frame

    video.playbackRate = 0.125;
    video.play().catch(() => {});

    // Accumulator canvas - holds the blended result
    let accum = null;
    let accumCtx = null;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    function initAccum() {
        accum = document.createElement('canvas');
        accum.width = video.videoWidth || 1920;
        accum.height = video.videoHeight || 1080;
        accumCtx = accum.getContext('2d');
        // Initialize with first frame
        accumCtx.drawImage(video, 0, 0, accum.width, accum.height);
    }

    function render() {
        if (video.readyState >= 2) {
            if (!accum) initAccum();

            // Blend current video frame into accumulator
            accumCtx.globalAlpha = blendRate;
            accumCtx.drawImage(video, 0, 0, accum.width, accum.height);
            accumCtx.globalAlpha = 1.0;

            // Draw accumulator to display canvas
            ctx.drawImage(accum, 0, 0, canvas.width, canvas.height);
        }
        requestAnimationFrame(render);
    }

    video.addEventListener('loadeddata', render);
    if (video.readyState >= 2) render();
})();
</script>
{% endblock %}


